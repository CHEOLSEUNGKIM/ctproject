<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=600, initial-scale=1.0" />
  <title>배드민턴 포지셔닝 시뮬레이터</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f2f2f2;}
    #layout { display: flex; flex-direction: row; align-items: flex-start; justify-content: center; margin-top: 16px; }
    #mainPanel { min-width: 450px; }
    #sidePanel { min-width: 310px; max-width: 340px; padding-left: 20px; height: 715px; box-sizing: border-box; display: flex; flex-direction: column; align-items: flex-start; }
    #court { position: relative; width: 400px; height: 600px; background-color: #e0f7fa; margin: 20px auto 0 auto; border: 2px solid #000; box-shadow: 1px 2px 11px #cfebf5; }
    #centerLine { position: absolute; border-left: 2px solid #1976D2; height: 100%; left: 50%; top: 0; transform: translateX(-1px); opacity: 0.8; z-index: 9; pointer-events: none;}
    .player { position: absolute; width: 60px; height: 30px; background-color: #ffcc80; border: 1px solid #000; text-align: center; line-height: 30px; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: outline 0.15s; }
    #net { position: absolute; width: 100%; height: 4px; background-color: #000; top: 50%; left: 0; transform: translateY(-2px); z-index: 11;}
    #shuttlecock { position: absolute; width: 15px; height: 15px; background-color: red; border-radius: 50%; display: none; z-index: 12; }
    select, button { margin: 5px; font-size: 15px;}
    #log { margin-top: 18px; text-align: left; width: 400px; margin-left: auto; margin-right: auto; min-height: 42px; font-size: 15px;}
    #shotHistoryContainer { width: 100%; padding-top: 10px; }
    #shotHistoryList { width: 99%; min-height: 60px; background: #fff; box-shadow: 0 0 8px #cdeefa34; border-radius: 7px; padding: 12px 8px 12px 18px; margin-bottom: 40px; font-size: 15px; max-height: 510px; overflow-y: auto; }
    #shotHistoryTitle { font-weight: bold; font-size: 17px; color: #1668b3; margin-bottom: 12px; margin-top: 2px;}
    .shotItem { margin-bottom: 6px;}
    #swapButtons { margin-top: 12px; text-align: center;}
  </style>
</head>
<body>
  <h2 style="text-align:center;">배드민턴 포지셔닝 시뮬레이터</h2>
  <div id="layout">
    <div id="mainPanel">
      <div style="margin-bottom: 2px;">
        <input type="text" id="playerAName" placeholder="선수 A 이름" />
        <input type="text" id="playerBName" placeholder="선수 B 이름" />
        <input type="text" id="playerCName" placeholder="선수 C 이름" />
        <input type="text" id="playerDName" placeholder="선수 D 이름" />
        <button onclick="setPlayerNames()">이름 설정하기</button>
      </div>
      <div>
        <select id="senderSelect"></select>
        <select id="receiverSelect"></select>
        <select id="skillSelect">
          <option value="숏 서브">숏 서브</option>
          <option value="롱 서브">롱 서브</option>
          <option value="드롭">드롭</option>
          <option value="스매시">스매시</option>
          <option value="헤어핀">헤어핀</option>
          <option value="드라이브">드라이브</option>
          <option value="언더클리어">언더클리어</option>
          <option value="하이클리어">하이클리어</option>
          <option value="커트 수비">커트 수비</option>
          <option value="클리어 수비">클리어 수비</option>
        </select>
        <button onclick="executeSkill()">기술 사용</button>
        <button onclick="goBack()">이전</button>
        <button onclick="resetAll()">초기화</button>
      </div>
      <div id="court">
        <div id="centerLine"></div>
        <div id="net"></div>
        <div id="shuttlecock"></div>
        <div class="player" id="A"></div>
        <div class="player" id="B"></div>
        <div class="player" id="C"></div>
        <div class="player" id="D"></div>
      </div>
      <div id="swapButtons">
        <button onclick="swapPositions('AB')">AB 위치 바꾸기</button>
        <button onclick="swapPositions('CD')">CD 위치 바꾸기</button>
      </div>
      <div id="log"></div>
    </div>
    <div id="sidePanel">
      <div id="shotHistoryContainer">
        <div id="shotHistoryTitle">샷(스트로크) 순차 기록</div>
        <div id="shotHistoryList"></div>
      </div>
    </div>
  </div>
  <script>
    const skillList = [
      "숏 서브","롱 서브","드롭","스매시","헤어핀","드라이브","언더클리어","하이클리어","커트 수비","클리어 수비"
    ];
    const players = {
      A: { name: 'A', team: 'AB' },
      B: { name: 'B', team: 'AB' },
      C: { name: 'C', team: 'CD' },
      D: { name: 'D', team: 'CD' },
    };

    let history = [];

    // 초기 위치 - 좌우 코트 중앙 기준
    let manualPositions = {
      A: [100, 520],  // A 좌측 하단 중앙
      B: [300, 520],  // B 우측 하단 중앙
      C: [100, 50],   // C 좌측 상단 중앙
      D: [300, 50]    // D 우측 상단 중앙
    };

    // 선수 클릭 위치 교환 관련
    let selectedPlayerId = null;

    function clearAllOutlines() {
      for (let id of ['A','B','C','D']) {
        document.getElementById(id).style.outline = "";
      }
    }

    function onPlayerClick(e) {
      const id = e.target.id;
      if (!selectedPlayerId) {
        selectedPlayerId = id;
        clearAllOutlines();
        document.getElementById(id).style.outline = "3px solid #1976D2";
      } else if (selectedPlayerId && selectedPlayerId !== id) {
        // 위치 교환
        const temp = [...manualPositions[selectedPlayerId]];
        manualPositions[selectedPlayerId] = [...manualPositions[id]];
        manualPositions[id] = temp;
        updatePositions();
        clearAllOutlines();
        selectedPlayerId = null;
      } else {
        clearAllOutlines();
        selectedPlayerId = null;
      }
    }

    function setPlayerNames() {
      players.A.name = document.getElementById('playerAName').value || 'A';
      players.B.name = document.getElementById('playerBName').value || 'B';
      players.C.name = document.getElementById('playerCName').value || 'C';
      players.D.name = document.getElementById('playerDName').value || 'D';
      updateDropdowns();
      updatePositions();
      renderShotHistory();
    }

    function updateDropdowns() {
      const senderSelect = document.getElementById('senderSelect');
      const receiverSelect = document.getElementById('receiverSelect');
      senderSelect.innerHTML = '';
      receiverSelect.innerHTML = '';
      for (const key in players) {
        const p = players[key];
        const senderOption = new Option(p.name, key);
        senderSelect.appendChild(senderOption);
      }
      updateReceiverOptions();
      senderSelect.onchange = updateReceiverOptions;
    }

    function updateReceiverOptions() {
      const sender = document.getElementById('senderSelect').value;
      const receiverSelect = document.getElementById('receiverSelect');
      receiverSelect.innerHTML = '';
      for (const key in players) {
        if (key !== sender && players[sender].team !== players[key].team) {
          const option = new Option(players[key].name, key);
          receiverSelect.appendChild(option);
        }
      }
    }

    function updatePositions() {
      for (const id of ['A','B','C','D']) {
        const [x, y] = manualPositions[id];
        const elem = document.getElementById(id);
        elem.style.left = x + 'px';
        elem.style.top = y + 'px';
        elem.textContent = players[id].name;
      }
      clearAllOutlines();
      selectedPlayerId = null;
    }

    function executeSkill() {
      const sender = document.getElementById('senderSelect').value;
      const receiver = document.getElementById('receiverSelect').value;
      const skill = document.getElementById('skillSelect').value;
      history.push({ sender, receiver, skill });

      renderShotHistory();

      animateShuttle(sender, receiver);

      applyPositioning(sender, receiver, skill);

      const log = document.getElementById('log');
      log.innerHTML += `<p>${players[sender].name} → ${players[receiver].name} : ${skill}</p>`;

      document.getElementById('senderSelect').value = receiver;
      updateReceiverOptions();
    }

    // 상황별 포지셔닝 - 항상 좌우 코트 중앙 기준 유지
    function applyPositioning(sender, receiver, skill) {
      const teamSender = players[sender].team;
      const partnerSender = Object.keys(players).find(p => players[p].team === teamSender && p !== sender);
      const teamReceiver = players[receiver].team;
      const partnerReceiver = Object.keys(players).find(p => players[p].team === teamReceiver && p !== receiver);

      let pos = {...manualPositions}; // 기존 위치 복사

      if (["하이클리어", "언더클리어", "클리어 수비", "롱 서브"].includes(skill)) {
        // 보낸 팀 양쪽 옆 (수비)
        if (teamSender === 'AB') {
          pos.A = [100, 520]; pos.B = [300, 520];
        } else {
          pos.C = [100, 50]; pos.D = [300, 50];
        }
        // 받은 팀 후위+전위 (공격)
        if (teamReceiver === 'AB') {
          pos[receiver] = [200, 550];
          pos[partnerReceiver] = [200, 480];
        } else {
          pos[receiver] = [200, 20];
          pos[partnerReceiver] = [200, 90];
        }
      }
      else if (skill === "커트 수비") {
        if (teamSender === 'AB') {
          pos[sender] = [200, 480];
          pos[partnerSender] = [200, 550];
        } else {
          pos[sender] = [200, 90];
          pos[partnerSender] = [200, 20];
        }
      }
      else if (skill === "숏 서브") {
        if (teamSender === 'AB') {
          pos[sender] = [200, 480];
          pos[partnerSender] = [200, 550];
        } else {
          pos[sender] = [200, 90];
          pos[partnerSender] = [200, 20];
        }
      }
      else if (skill === "헤어핀") {
        // 헤어핀 구사자는 전위, 파트너 후위 (좌우 코트 중앙 기준)
        if (teamSender === 'AB') {
          pos[sender] = [300, 480];      // B 위치 같은 우측 코트 중앙 전위에 가깝게
          pos[partnerSender] = [100, 550];
        } else {
          pos[sender] = [300, 90];
          pos[partnerSender] = [100, 20];
        }
      }
      else if (["스매시", "드롭", "드라이브"].includes(skill)) {
        if (teamSender === 'AB') {
          pos[sender] = [100, 550];
          pos[partnerSender] = [300, 480];
        } else {
          pos[sender] = [100, 20];
          pos[partnerSender] = [300, 90];
        }
      }
      else {
        if (teamSender === 'AB') {
          pos[sender] = [100, 550];
          pos[partnerSender] = [300, 480];
        } else {
          pos[sender] = [100, 20];
          pos[partnerSender] = [300, 90];
        }
      }

      for(let k of ['A','B','C','D']) manualPositions[k] = [...pos[k]];
      updatePositions();
    }

    function swapPositions(team) {
      if(team === 'AB') {
        [manualPositions.A, manualPositions.B] = [manualPositions.B, manualPositions.A];
      } else {
        [manualPositions.C, manualPositions.D] = [manualPositions.D, manualPositions.C];
      }
      updatePositions();
    }

    function animateShuttle(from, to) {
      const fromElem = document.getElementById(from);
      const toElem = document.getElementById(to);
      const shuttle = document.getElementById('shuttlecock');
      const fromX = fromElem.offsetLeft + 20;
      const fromY = fromElem.offsetTop + 10;
      const toX = toElem.offsetLeft + 20;
      const toY = toElem.offsetTop + 10;
      shuttle.style.left = fromX + 'px';
      shuttle.style.top = fromY + 'px';
      shuttle.style.display = 'block';
      shuttle.animate([
        { left: fromX + 'px', top: fromY + 'px' },
        { left: toX + 'px', top: toY + 'px' }
      ], {
        duration: 600,
        fill: 'forwards'
      });
      setTimeout(() => { shuttle.style.display = 'none'; }, 700);
    }

    function goBack() {
      history.pop();
      document.getElementById('log').innerHTML = '';
      manualPositions = {
        A: [100, 520], B: [300, 520],
        C: [100, 50],  D: [300, 50]
      };
      if(history.length > 0) {
        history.forEach(({ sender, receiver, skill }) => {
          applyPositioning(sender, receiver, skill);
          document.getElementById('log').innerHTML += `<p>${players[sender].name} → ${players[receiver].name} : ${skill}</p>`;
        });
      } else {
        updatePositions();
      }
      renderShotHistory();
    }

    function resetAll() {
      history = [];
      document.getElementById('log').innerHTML = '';
      manualPositions = {
        A: [100, 520], B: [300, 520],
        C: [100, 50],  D: [300, 50]
      };
      updatePositions();
      renderShotHistory();
    }

    function renderShotHistory() {
      const shotListDiv = document.getElementById('shotHistoryList');
      shotListDiv.innerHTML = history.length === 0
        ? `<div style="color:#89a0b8;font-size:15px;">아직 샷 기록이 없습니다.</div>`
        : history.slice().reverse().map(
            ({sender, receiver, skill}) =>
              `<div class="shotItem"><span style="color:#1668b3;font-weight:bold;">${players[sender].name}</span> &rarr; <span style="color:#e66413;">${players[receiver].name}</span> : <span style="color:#1976d2;">${skill}</span></div>`
          ).join('');
    }

    window.addEventListener('DOMContentLoaded', () => {
      for (let id of ['A','B','C','D']) {
        document.getElementById(id).addEventListener('click', onPlayerClick);
      }
      setPlayerNames();
    });
  </script>
</body>
</html>
